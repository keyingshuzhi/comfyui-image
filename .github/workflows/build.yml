name: build-and-publish

on:
  workflow_call:
    inputs:
      comfyui_ref:
        description: "Upstream ComfyUI git ref (tag/commit/branch), e.g. v0.3.26"
        required: false
        default: ""
        type: string
      comfyui_repo:
        description: "Upstream ComfyUI repo URL"
        required: false
        default: ""
        type: string
      base_image:
        description: "Base image for Dockerfile, e.g. python:3.12-slim"
        required: false
        default: ""
        type: string
      push_stable:
        description: "Also tag and push :stable if smoke test passes"
        required: false
        default: ""
        type: string
      registry:
        description: "Container registry host, e.g. ghcr.io or registry.example.com"
        required: false
        default: ""
        type: string
      image_prefix:
        description: "Registry namespace/project path, e.g. org/team"
        required: false
        default: ""
        type: string
      image_repo:
        description: "Image repo name, e.g. comfyui"
        required: false
        default: ""
        type: string
      event_name:
        description: "Caller event name, e.g. push, pull_request, workflow_dispatch"
        required: false
        default: ""
        type: string
    secrets:
      REGISTRY_USERNAME:
        required: false
      REGISTRY_PASSWORD:
        required: false

env:
  REGISTRY: ${{ vars.REGISTRY || 'ghcr.io' }}
  IMAGE_PREFIX: ${{ vars.IMAGE_PREFIX || '' }}
  IMAGE_REPO: ${{ vars.IMAGE_REPO || 'comfyui' }}
  COMFYUI_REF: ${{ vars.COMFYUI_REF || 'v0.9.2' }}
  COMFYUI_REPO: ${{ vars.COMFYUI_REPO || 'https://github.com/comfyanonymous/ComfyUI.git' }}
  BASE_IMAGE: ${{ vars.BASE_IMAGE || 'python:3.12-slim' }}

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Compute vars
        shell: bash
        run: |
          # 1) owner must be lowercase for ghcr
          OWNER_LC="$(echo "${{ github.repository_owner }}" | tr '[:upper:]' '[:lower:]')"
          echo "OWNER_LC=${OWNER_LC}" >> "$GITHUB_ENV"

          # 2) choose comfyui ref
          REF_INPUT="${{ inputs.comfyui_ref }}"
          if [ -z "${REF_INPUT}" ]; then
            REF_INPUT="${COMFYUI_REF}"
          fi
          echo "COMFYUI_REF=${REF_INPUT}" >> "$GITHUB_ENV"

          # 3) choose comfyui repo (default official)
          REPO_INPUT="${{ inputs.comfyui_repo }}"
          if [ -z "${REPO_INPUT}" ]; then
            REPO_INPUT="${COMFYUI_REPO}"
          fi
          echo "COMFYUI_REPO=${REPO_INPUT}" >> "$GITHUB_ENV"

          # 4) choose base image (default python slim)
          BASE_IMAGE_INPUT="${{ inputs.base_image }}"
          if [ -z "${BASE_IMAGE_INPUT}" ]; then
            BASE_IMAGE_INPUT="${BASE_IMAGE}"
          fi
          echo "BASE_IMAGE=${BASE_IMAGE_INPUT}" >> "$GITHUB_ENV"

          # 5) choose registry + image naming
          REGISTRY_INPUT="${{ inputs.registry }}"
          if [ -z "${REGISTRY_INPUT}" ]; then
            REGISTRY_INPUT="${REGISTRY}"
          fi
          echo "REGISTRY=${REGISTRY_INPUT}" >> "$GITHUB_ENV"

          IMAGE_REPO_INPUT="${{ inputs.image_repo }}"
          if [ -z "${IMAGE_REPO_INPUT}" ]; then
            IMAGE_REPO_INPUT="${IMAGE_REPO}"
          fi
          echo "IMAGE_REPO=${IMAGE_REPO_INPUT}" >> "$GITHUB_ENV"

          IMAGE_PREFIX_INPUT="${{ inputs.image_prefix }}"
          if [ -z "${IMAGE_PREFIX_INPUT}" ]; then
            IMAGE_PREFIX_INPUT="${IMAGE_PREFIX}"
          fi
          if [ -z "${IMAGE_PREFIX_INPUT}" ]; then
            IMAGE_PREFIX_INPUT="${OWNER_LC}"
          fi
          if [ "${REGISTRY_INPUT}" = "ghcr.io" ]; then
            IMAGE_PREFIX_INPUT="$(echo "${IMAGE_PREFIX_INPUT}" | tr '[:upper:]' '[:lower:]')"
          fi
          echo "IMAGE_PREFIX=${IMAGE_PREFIX_INPUT}" >> "$GITHUB_ENV"

          # 6) capture caller event name
          EVENT_NAME_INPUT="${{ inputs.event_name }}"
          if [ -z "${EVENT_NAME_INPUT}" ]; then
            EVENT_NAME_INPUT="${GITHUB_EVENT_NAME}"
          fi
          echo "EVENT_NAME=${EVENT_NAME_INPUT}" >> "$GITHUB_ENV"

          # 7) sanitize ref to a safe docker tag
          SAFE_TAG="$(echo "${REF_INPUT}" \
            | tr '/:@ ' '----' \
            | tr -cd 'a-zA-Z0-9_.-')"
          if [ -z "${SAFE_TAG}" ]; then SAFE_TAG="ref"; fi
          echo "SAFE_TAG=${SAFE_TAG}" >> "$GITHUB_ENV"

          # 8) full image name
          echo "IMAGE=${REGISTRY_INPUT}/${IMAGE_PREFIX_INPUT}/${IMAGE_REPO_INPUT}" >> "$GITHUB_ENV"

          # 9) should push stable?
          # - caller uses input
          # - push/pr 默认不推 stable（避免自动“踩雷升级”）
          PUSH_STABLE="${{ inputs.push_stable }}"
          if [ -z "${PUSH_STABLE}" ]; then
            PUSH_STABLE="false"
          fi
          echo "PUSH_STABLE=${PUSH_STABLE}" >> "$GITHUB_ENV"

          # 10) add a sha tag for traceability
          SHORT_SHA="$(echo "${GITHUB_SHA}" | cut -c1-7)"
          echo "SHA_TAG=sha-${SHORT_SHA}" >> "$GITHUB_ENV"

          echo "[vars] IMAGE=${REGISTRY_INPUT}/${IMAGE_PREFIX_INPUT}/${IMAGE_REPO_INPUT}"
          echo "[vars] COMFYUI_REF=${REF_INPUT}"
          echo "[vars] COMFYUI_REPO=${REPO_INPUT}"
          echo "[vars] BASE_IMAGE=${BASE_IMAGE_INPUT}"
          echo "[vars] EVENT_NAME=${EVENT_NAME_INPUT}"
          echo "[vars] SAFE_TAG=${SAFE_TAG}"
          echo "[vars] SHA_TAG=sha-${SHORT_SHA}"
          echo "[vars] PUSH_STABLE=${PUSH_STABLE}"

      - name: Log in to GHCR
        if: ${{ env.EVENT_NAME != 'pull_request' && env.REGISTRY == 'ghcr.io' }}
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Log in to custom registry
        if: ${{ env.EVENT_NAME != 'pull_request' && env.REGISTRY != 'ghcr.io' }}
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ secrets.REGISTRY_USERNAME }}
          password: ${{ secrets.REGISTRY_PASSWORD }}

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      # Build (load locally) for smoke test — force amd64 so --load works reliably
      - name: Build (local load) for smoke test
        run: |
          docker buildx build \
            --platform linux/amd64 \
            --file docker/Dockerfile \
            --build-arg BASE_IMAGE="${BASE_IMAGE}" \
            --build-arg COMFYUI_REF="${COMFYUI_REF}" \
            --build-arg COMFYUI_REPO="${COMFYUI_REPO}" \
            --tag "${IMAGE}:${SAFE_TAG}" \
            --load \
            .

      - name: Smoke test
        run: |
          chmod +x scripts/healthcheck.sh
          IMAGE_UNDER_TEST="${IMAGE}:${SAFE_TAG}" ./scripts/healthcheck.sh 18188 comfyui_smoke

      # On PR: only test, do not push
      - name: Build & Push (tag + sha)
        if: ${{ env.EVENT_NAME != 'pull_request' }}
        run: |
          docker buildx build \
            --platform linux/amd64 \
            --file docker/Dockerfile \
            --build-arg BASE_IMAGE="${BASE_IMAGE}" \
            --build-arg COMFYUI_REF="${COMFYUI_REF}" \
            --build-arg COMFYUI_REPO="${COMFYUI_REPO}" \
            --tag "${IMAGE}:${SAFE_TAG}" \
            --tag "${IMAGE}:${SHA_TAG}" \
            --cache-from type=gha \
            --cache-to type=gha,mode=max \
            --push \
            .

      - name: Tag & Push stable (optional)
        if: ${{ env.EVENT_NAME != 'pull_request' && env.PUSH_STABLE == 'true' }}
        run: |
          docker buildx build \
            --platform linux/amd64 \
            --file docker/Dockerfile \
            --build-arg BASE_IMAGE="${BASE_IMAGE}" \
            --build-arg COMFYUI_REF="${COMFYUI_REF}" \
            --build-arg COMFYUI_REPO="${COMFYUI_REPO}" \
            --tag "${IMAGE}:stable" \
            --cache-from type=gha \
            --cache-to type=gha,mode=max \
            --push \
            .
