name: build-and-publish

on:
  workflow_call:
    inputs:
      comfyui_ref:
        description: "Upstream ComfyUI git ref (tag/commit/branch), e.g. v0.9.2"
        required: false
        default: ""
        type: string
      comfyui_repo:
        description: "Upstream ComfyUI repo URL"
        required: false
        default: ""
        type: string
      base_image:
        description: "Base image for Dockerfile, e.g. python:3.12-slim"
        required: false
        default: ""
        type: string
      push_stable:
        description: "Also tag and push :stable if smoke test passes"
        required: false
        default: ""
        type: string
      registry:
        description: "Container registry host, e.g. ghcr.io or registry.example.com"
        required: false
        default: ""
        type: string
      image_prefix:
        description: "Registry namespace/project path, e.g. org/team"
        required: false
        default: ""
        type: string
      image_repo:
        description: "Image repo name, e.g. comfyui"
        required: false
        default: ""
        type: string
    secrets:
      REGISTRY_USERNAME:
        required: false
      REGISTRY_PASSWORD:
        required: false

env:
  # repo variables as defaults (callee repo)
  REGISTRY: ${{ vars.REGISTRY || 'ghcr.io' }}
  IMAGE_PREFIX: ${{ vars.IMAGE_PREFIX || '' }}
  IMAGE_REPO: ${{ vars.IMAGE_REPO || 'comfyui' }}
  COMFYUI_REF: ${{ vars.COMFYUI_REF || 'v0.9.2' }}
  # FIX: default to Comfy-Org (release tags like v0.9.2 exist here)
  COMFYUI_REPO: ${{ vars.COMFYUI_REPO || 'https://github.com/Comfy-Org/ComfyUI.git' }}
  BASE_IMAGE: ${{ vars.BASE_IMAGE || 'python:3.12-slim' }}

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Compute vars
        id: vars
        shell: bash
        run: |
          set -euo pipefail

          # owner must be lowercase for ghcr
          OWNER_LC="$(echo "${{ github.repository_owner }}" | tr '[:upper:]' '[:lower:]')"

          # choose comfyui ref
          REF_INPUT="${{ inputs.comfyui_ref }}"
          if [ -z "${REF_INPUT}" ]; then REF_INPUT="${COMFYUI_REF}"; fi

          # choose comfyui repo
          REPO_INPUT="${{ inputs.comfyui_repo }}"
          if [ -z "${REPO_INPUT}" ]; then REPO_INPUT="${COMFYUI_REPO}"; fi

          # choose base image
          BASE_IMAGE_INPUT="${{ inputs.base_image }}"
          if [ -z "${BASE_IMAGE_INPUT}" ]; then BASE_IMAGE_INPUT="${BASE_IMAGE}"; fi

          # choose registry
          REGISTRY_INPUT="${{ inputs.registry }}"
          if [ -z "${REGISTRY_INPUT}" ]; then REGISTRY_INPUT="${REGISTRY}"; fi

          # image repo name
          IMAGE_REPO_INPUT="${{ inputs.image_repo }}"
          if [ -z "${IMAGE_REPO_INPUT}" ]; then IMAGE_REPO_INPUT="${IMAGE_REPO}"; fi

          # image prefix
          IMAGE_PREFIX_INPUT="${{ inputs.image_prefix }}"
          if [ -z "${IMAGE_PREFIX_INPUT}" ]; then IMAGE_PREFIX_INPUT="${IMAGE_PREFIX}"; fi
          if [ -z "${IMAGE_PREFIX_INPUT}" ]; then IMAGE_PREFIX_INPUT="${OWNER_LC}"; fi

          # GHCR requires lowercase image names
          if [ "${REGISTRY_INPUT}" = "ghcr.io" ]; then
            IMAGE_PREFIX_INPUT="$(echo "${IMAGE_PREFIX_INPUT}" | tr '[:upper:]' '[:lower:]')"
            IMAGE_REPO_INPUT="$(echo "${IMAGE_REPO_INPUT}" | tr '[:upper:]' '[:lower:]')"
          fi

          # event name (workflow_call 本身没必要传 event_name，用 github.event_name 即可)
          EVENT_NAME_INPUT="${GITHUB_EVENT_NAME}"

          # safe docker tag
          SAFE_TAG="$(echo "${REF_INPUT}" | tr '/:@ ' '----' | tr -cd 'a-zA-Z0-9_.-')"
          if [ -z "${SAFE_TAG}" ]; then SAFE_TAG="ref"; fi

          # full image name
          IMAGE="${REGISTRY_INPUT}/${IMAGE_PREFIX_INPUT}/${IMAGE_REPO_INPUT}"

          # push stable?
          PUSH_STABLE_INPUT="${{ inputs.push_stable }}"
          if [ -z "${PUSH_STABLE_INPUT}" ]; then PUSH_STABLE_INPUT="false"; fi

          SHORT_SHA="$(echo "${GITHUB_SHA}" | cut -c1-7)"
          SHA_TAG="sha-${SHORT_SHA}"

          # export for later shell steps
          {
            echo "OWNER_LC=${OWNER_LC}"
            echo "COMFYUI_REF=${REF_INPUT}"
            echo "COMFYUI_REPO=${REPO_INPUT}"
            echo "BASE_IMAGE=${BASE_IMAGE_INPUT}"
            echo "REGISTRY=${REGISTRY_INPUT}"
            echo "IMAGE_PREFIX=${IMAGE_PREFIX_INPUT}"
            echo "IMAGE_REPO=${IMAGE_REPO_INPUT}"
            echo "EVENT_NAME=${EVENT_NAME_INPUT}"
            echo "SAFE_TAG=${SAFE_TAG}"
            echo "IMAGE=${IMAGE}"
            echo "PUSH_STABLE=${PUSH_STABLE_INPUT}"
            echo "SHA_TAG=${SHA_TAG}"
          } >> "$GITHUB_ENV"

          # outputs for if conditions (avoid "env.*" red underline / ambiguity)
          {
            echo "event_name=${EVENT_NAME_INPUT}"
            echo "registry=${REGISTRY_INPUT}"
            echo "image=${IMAGE}"
            echo "safe_tag=${SAFE_TAG}"
            echo "sha_tag=${SHA_TAG}"
            echo "push_stable=${PUSH_STABLE_INPUT}"
          } >> "$GITHUB_OUTPUT"

          echo "[vars] IMAGE=${IMAGE}"
          echo "[vars] COMFYUI_REF=${REF_INPUT}"
          echo "[vars] COMFYUI_REPO=${REPO_INPUT}"
          echo "[vars] BASE_IMAGE=${BASE_IMAGE_INPUT}"
          echo "[vars] EVENT_NAME=${EVENT_NAME_INPUT}"
          echo "[vars] SAFE_TAG=${SAFE_TAG}"
          echo "[vars] SHA_TAG=${SHA_TAG}"
          echo "[vars] PUSH_STABLE=${PUSH_STABLE_INPUT}"

      - name: Log in to GHCR
        if: ${{ steps.vars.outputs.event_name != 'pull_request' && steps.vars.outputs.registry == 'ghcr.io' }}
        uses: docker/login-action@v3
        with:
          registry: ${{ steps.vars.outputs.registry }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Log in to custom registry
        if: ${{ steps.vars.outputs.event_name != 'pull_request' && steps.vars.outputs.registry != 'ghcr.io' }}
        uses: docker/login-action@v3
        with:
          registry: ${{ steps.vars.outputs.registry }}
          username: ${{ secrets.REGISTRY_USERNAME }}
          password: ${{ secrets.REGISTRY_PASSWORD }}

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build (local load) for smoke test
        run: |
          docker buildx build \
            --platform linux/amd64 \
            --file docker/Dockerfile \
            --build-arg BASE_IMAGE="${BASE_IMAGE}" \
            --build-arg COMFYUI_REF="${COMFYUI_REF}" \
            --build-arg COMFYUI_REPO="${COMFYUI_REPO}" \
            --tag "${IMAGE}:${SAFE_TAG}" \
            --load \
            .

      - name: Smoke test
        run: |
          chmod +x scripts/healthcheck.sh
          IMAGE_UNDER_TEST="${IMAGE}:${SAFE_TAG}" ./scripts/healthcheck.sh 18188 comfyui_smoke

      - name: Build & Push (tag + sha)
        if: ${{ steps.vars.outputs.event_name != 'pull_request' }}
        run: |
          docker buildx build \
            --platform linux/amd64 \
            --file docker/Dockerfile \
            --build-arg BASE_IMAGE="${BASE_IMAGE}" \
            --build-arg COMFYUI_REF="${COMFYUI_REF}" \
            --build-arg COMFYUI_REPO="${COMFYUI_REPO}" \
            --tag "${IMAGE}:${SAFE_TAG}" \
            --tag "${IMAGE}:${SHA_TAG}" \
            --cache-from type=gha \
            --cache-to type=gha,mode=max \
            --push \
            .

      - name: Tag & Push stable (optional)
        if: ${{ steps.vars.outputs.event_name != 'pull_request' && steps.vars.outputs.push_stable == 'true' }}
        run: |
          docker buildx build \
            --platform linux/amd64 \
            --file docker/Dockerfile \
            --build-arg BASE_IMAGE="${BASE_IMAGE}" \
            --build-arg COMFYUI_REF="${COMFYUI_REF}" \
            --build-arg COMFYUI_REPO="${COMFYUI_REPO}" \
            --tag "${IMAGE}:stable" \
            --cache-from type=gha \
            --cache-to type=gha,mode=max \
            --push \
            .
