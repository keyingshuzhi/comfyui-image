name: docker-image

on:
  workflow_dispatch:
    inputs:
      comfyui_ref:
        description: "Upstream ComfyUI git ref (tag/commit/branch), e.g. v0.9.2"
        required: true
        default: "v0.9.2"
      push_stable:
        description: "Also tag and push :stable if smoke test passes"
        required: true
        default: "true"
  push:
    branches: ["main"]
  pull_request:
    branches: ["main"]

env:
  REGISTRY: ghcr.io
  IMAGE_REPO: comfyui
  COMFYUI_REPO: https://github.com/Comfy-Org/ComfyUI.git

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Free disk space
        run: |
          df -h
          sudo rm -rf /usr/share/dotnet /usr/local/lib/android /opt/ghc || true
          sudo apt-get clean
          docker system prune -af || true
          df -h

      - name: Compute vars
        shell: bash
        run: |
          OWNER_LC="$(echo "${{ github.repository_owner }}" | tr '[:upper:]' '[:lower:]')"
          echo "OWNER_LC=${OWNER_LC}" >> "$GITHUB_ENV"

          REF_INPUT="${{ github.event.inputs.comfyui_ref }}"
          if [ -z "${REF_INPUT}" ]; then REF_INPUT="v0.9.2"; fi
          echo "COMFYUI_REF=${REF_INPUT}" >> "$GITHUB_ENV"

          SAFE_TAG="$(echo "${REF_INPUT}" | tr '/:@ ' '----' | tr -cd 'a-zA-Z0-9_.-')"
          if [ -z "${SAFE_TAG}" ]; then SAFE_TAG="ref"; fi
          echo "SAFE_TAG=${SAFE_TAG}" >> "$GITHUB_ENV"

          echo "IMAGE=${{ env.REGISTRY }}/${OWNER_LC}/${{ env.IMAGE_REPO }}" >> "$GITHUB_ENV"

          SHORT_SHA="$(echo "${GITHUB_SHA}" | cut -c1-7)"
          echo "SHA_TAG=sha-${SHORT_SHA}" >> "$GITHUB_ENV"

          echo "[vars] IMAGE=${{ env.REGISTRY }}/${OWNER_LC}/${{ env.IMAGE_REPO }}"
          echo "[vars] COMFYUI_REPO=${{ env.COMFYUI_REPO }}"
          echo "[vars] COMFYUI_REF=${REF_INPUT}"
          echo "[vars] SAFE_TAG=${SAFE_TAG}"
          echo "[vars] SHA_TAG=sha-${SHORT_SHA}"

      - name: Log in to GHCR
        if: ${{ github.event_name != 'pull_request' }}
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build (local load) for smoke test
        run: |
          docker buildx build \
            --platform linux/amd64 \
            --file docker/Dockerfile \
            --build-arg COMFYUI_REF="${COMFYUI_REF}" \
            --build-arg COMFYUI_REPO="${COMFYUI_REPO}" \
            --tag "${IMAGE}:${SAFE_TAG}" \
            --load \
            .

      - name: Smoke test
        run: |
          chmod +x scripts/healthcheck.sh
          IMAGE_UNDER_TEST="${IMAGE}:${SAFE_TAG}" ./scripts/healthcheck.sh 18188 comfyui_smoke

      - name: Build & Push (tag + sha)
        if: ${{ github.event_name != 'pull_request' }}
        run: |
          docker buildx build \
            --platform linux/amd64 \
            --file docker/Dockerfile \
            --build-arg COMFYUI_REF="${COMFYUI_REF}" \
            --build-arg COMFYUI_REPO="${COMFYUI_REPO}" \
            --tag "${IMAGE}:${SAFE_TAG}" \
            --tag "${IMAGE}:${SHA_TAG}" \
            --cache-from type=gha \
            --cache-to type=gha,mode=max \
            --push \
            .

      - name: Tag & Push stable (optional, dispatch only)
        if: ${{ github.event_name == 'workflow_dispatch' && github.event.inputs.push_stable == 'true' }}
        run: |
          docker buildx build \
            --platform linux/amd64 \
            --file docker/Dockerfile \
            --build-arg COMFYUI_REF="${COMFYUI_REF}" \
            --build-arg COMFYUI_REPO="${COMFYUI_REPO}" \
            --tag "${IMAGE}:stable" \
            --cache-from type=gha \
            --cache-to type=gha,mode=max \
            --push \
            .
