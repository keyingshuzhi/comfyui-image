name: docker-image

on:
  workflow_dispatch:
    inputs:
      comfyui_ref:
        description: "Upstream ComfyUI git ref (tag/commit/branch), e.g. v0.9.2"
        required: true
        default: "master"
      push_stable:
        description: "Also tag and push :stable if smoke test passes"
        required: true
        default: "true"
  push:
    branches: ["main"]
  pull_request:
    branches: ["main"]

env:
  REGISTRY: ghcr.io
  IMAGE_REPO: comfyui
  # Ensure we always build from the official org repo (where release tags like v0.9.2 exist)
  COMFYUI_REPO: https://github.com/Comfy-Org/ComfyUI.git

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Compute vars
        shell: bash
        run: |
          # owner must be lowercase for ghcr
          OWNER_LC="$(echo "${{ github.repository_owner }}" | tr '[:upper:]' '[:lower:]')"
          echo "OWNER_LC=${OWNER_LC}" >> "$GITHUB_ENV"

          # choose comfyui ref
          REF_INPUT="${{ github.event.inputs.comfyui_ref }}"
          if [ -z "${REF_INPUT}" ]; then
            REF_INPUT="master"
          fi
          echo "COMFYUI_REF=${REF_INPUT}" >> "$GITHUB_ENV"

          # sanitize ref to safe docker tag
          SAFE_TAG="$(echo "${REF_INPUT}" \
            | tr '/:@ ' '----' \
            | tr -cd 'a-zA-Z0-9_.-')"
          if [ -z "${SAFE_TAG}" ]; then SAFE_TAG="ref"; fi
          echo "SAFE_TAG=${SAFE_TAG}" >> "$GITHUB_ENV"

          # image name
          echo "IMAGE=${{ env.REGISTRY }}/${OWNER_LC}/${{ env.IMAGE_REPO }}" >> "$GITHUB_ENV"

          # stable switch (only from workflow_dispatch)
          PUSH_STABLE="${{ github.event.inputs.push_stable }}"
          if [ -z "${PUSH_STABLE}" ]; then PUSH_STABLE="false"; fi
          echo "PUSH_STABLE=${PUSH_STABLE}" >> "$GITHUB_ENV"

          # sha tag
          SHORT_SHA="$(echo "${GITHUB_SHA}" | cut -c1-7)"
          echo "SHA_TAG=sha-${SHORT_SHA}" >> "$GITHUB_ENV"

          echo "[vars] IMAGE=${{ env.REGISTRY }}/${OWNER_LC}/${{ env.IMAGE_REPO }}"
          echo "[vars] COMFYUI_REPO=${{ env.COMFYUI_REPO }}"
          echo "[vars] COMFYUI_REF=${REF_INPUT}"
          echo "[vars] SAFE_TAG=${SAFE_TAG}"
          echo "[vars] SHA_TAG=sha-${SHORT_SHA}"
          echo "[vars] PUSH_STABLE=${PUSH_STABLE}"

      - name: Log in to GHCR
        if: ${{ github.event_name != 'pull_request' }}
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      # Build (local load) for smoke test â€” use amd64 so --load is reliable
      - name: Build (local load) for smoke test
        run: |
          docker buildx build \
            --platform linux/amd64 \
            --file docker/Dockerfile \
            --build-arg COMFYUI_REF="${COMFYUI_REF}" \
            --build-arg COMFYUI_REPO="${COMFYUI_REPO}" \
            --tag "${IMAGE}:${SAFE_TAG}" \
            --load \
            .

      - name: Smoke test
        run: |
          chmod +x scripts/healthcheck.sh
          IMAGE_UNDER_TEST="${IMAGE}:${SAFE_TAG}" ./scripts/healthcheck.sh 18188 comfyui_smoke

      # PR: only test, no push
      - name: Build & Push (tag + sha)
        if: ${{ github.event_name != 'pull_request' }}
        run: |
          docker buildx build \
            --platform linux/amd64 \
            --file docker/Dockerfile \
            --build-arg COMFYUI_REF="${COMFYUI_REF}" \
            --build-arg COMFYUI_REPO="${COMFYUI_REPO}" \
            --tag "${IMAGE}:${SAFE_TAG}" \
            --tag "${IMAGE}:${SHA_TAG}" \
            --cache-from type=gha \
            --cache-to type=gha,mode=max \
            --push \
            .

      # Optional: keep an "edge" channel updated from main
      - name: Tag & Push edge (on main push)
        if: ${{ github.event_name == 'push' }}
        run: |
          docker buildx build \
            --platform linux/amd64 \
            --file docker/Dockerfile \
            --build-arg COMFYUI_REF="${COMFYUI_REF}" \
            --build-arg COMFYUI_REPO="${COMFYUI_REPO}" \
            --tag "${IMAGE}:edge" \
            --cache-from type=gha \
            --cache-to type=gha,mode=max \
            --push \
            .

      - name: Tag & Push stable (optional, dispatch only)
        if: ${{ github.event_name == 'workflow_dispatch' && github.event.inputs.push_stable == 'true' }}
        run: |
          docker buildx build \
            --platform linux/amd64 \
            --file docker/Dockerfile \
            --build-arg COMFYUI_REF="${COMFYUI_REF}" \
            --build-arg COMFYUI_REPO="${COMFYUI_REPO}" \
            --tag "${IMAGE}:stable" \
            --cache-from type=gha \
            --cache-to type=gha,mode=max \
            --push \
            .
